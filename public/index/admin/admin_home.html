<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="\css\admin\admin.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300&family=Poppins:wght@200&display=swap"
      rel="stylesheet"
    />
    <title>Admin Home</title>
  </head>
  <body>
    <div class="transparent-background"></div>

    <header>
      <h1>Welcome, <strong>Jane Doe</strong>!</h1>
      <div class="top-icons">
        <div class="dropdown">
          <div class="icon">
            <img
              src="/images/admin_images/account_circle.svg"
              alt="user logo"
            />
          </div>
          <div class="dropdown-content">
            <a href="#">Profile</a>
            <a href="#">Settings</a>
            <a href="#">Sign Out</a>
          </div>
        </div>
      </div>
    </header>
    <hr class="horizontal-line" />

    <div class="container">
      <nav class="side-nav">
        <ul>
          <li>
            <a href="#" onclick="loadContent('dashboard')">Dashboard Overview</a>
          </li>
          <li>
            <a href="#" onclick="loadContent('package')">Package Tracking</a>
          </li>
          <li>
            <a href="#" onclick="loadContent('customer-data')">Customer Data</a>
          </li>
          <li>
            <a href="#" onclick="loadContent('employee')">Employee Management</a>
          </li>
          <li>
            <a href="#" onclick="loadContent('salary')">Salary Report</a>
          </li>
          <li>
            <a href="#" onclick="loadContent('reports')">Sales Report</a>
          </li>
          <li>
            <a href="#" onclick="loadContent('supportreport')">Support Ticket Report</a>
          </li>
          <li>
            <a href="#" onclick="signOut()">Sign Out</a>
          </li>
        </ul>
      </nav>
      <main class="content">
        <div id="dashboard">
          <h1>Western Express: Administration Portal</h1>
          <div class="dashboard-info">
            <div class="dashboard-card">
              <h2>Today's Packages</h2>
              <p>Total: 50</p>
              <p>Delivered: 35</p>
              <p>Out for Delivery: 10</p>
              <p>In Transit: 5</p>
            </div>
            <div class="dashboard-card">
              <h2>Employee Stats</h2>
              <p>Total Employees: 100</p>
              <p>Active: 80</p>
              <p>Inactive: 20</p>
            </div>
            <div class="dashboard-card">
              <h2>Recent Shipments</h2>
              <ul>
                <li>Shipment 1234 - Delivered</li>
                <li>Shipment 5678 - In Transit</li>
                <li>Shipment 9012 - Delivered</li>
                <li>Shipment 3456 - Out for Delivery</li>
              </ul>
            </div>
          </div>
        </div>
        <div id="package">
          <div class="p-container">
            <h2>Package Tracker Form</h2>
            <form
              id="packageTrackerForm"
              action="submit_handler.php"
              method="post"
            >
              <div class="form-group">
                <label for="employeeId">Employee ID:</label>
                <input type="text" id="employeeId" name="employeeId" required />
              </div>
              <div class="form-group">
                <label for="trackerId">Tracker ID:</label>
                <input type="text" id="trackerId" name="trackerId" required />
              </div>
              <div class="form-group">
                <label for="name">Name:</label>
                <input type="text" id="name" name="name" />
              </div>
              <div class="form-group">
                <label for="date">Date:</label>
                <input type="date" id="date" name="date" />
              </div>
              <div class="form-group">
                <label for="street">Street Name:</label>
                <input type="text" id="street" name="street" />
              </div>
              <div class="form-group">
                <label for="city">City:</label>
                <input type="text" id="city" name="city" />
              </div>
              <div class="form-group">
                <label for="state">State:</label>
                <input type="text" id="state" name="state" />
              </div>
              <div class="form-group">
                <label for="zip">Zip Code:</label>
                <input type="text" id="zip" name="zip" />
              </div>
              <div class="form-group">
                <label for="packageClass">Package Class:</label>
                <input type="text" id="packageClass" name="packageClass" />
              </div>
              <div class="form-group">
                <button type="submit">Submit</button>
              </div>
            </form>
          </div>
        </div>
        <div id="customer-data">
          <div id ="customerData"></div>
        </div>
        <div id="employee">
          <h2>Employee Management</h2>
          <div id="shipment">
            <table id="shipmentTable">
              <thead>
                <tr>
                  <th>Location</th>
                  <th>Tracking ID</th>
                  <th>Name</th>
                  <th>Email</th>
                  <th>Subject</th>
                  <th>Category</th>
                  <th>Status</th>
                  <th>Created</th>
                </tr>
              </thead>
              <tbody>
                <!-- Table rows will be added dynamically via JavaScript -->
              </tbody>
            </table>
          </div>
        </div>

        <div id="salary">
          <div class="e-container">
            <div class="employmentRequestForm">
              <h2>Salary Report</h2>
              <form id="RequestForm" action="submit_handler.php" method="post">
                <div class="request-form">
                  <label for="title">Title:</label>
                  <select id="title" name="title">
                    <option value="ceo">CEO</option>
                    <option value="employee">Employee</option>
                    <option value="districtManager">District Manager</option>
                  </select>
                </div>

                <div class="request-form">
                  <label for="startDate">Start Date (optional):</label>
                  <input type="date" id="startDate" name="startDate" />
                </div>

                <div class="request-form">
                  <label for="terminationDate"
                    >Termination Date (optional):</label
                  >
                  <input
                    type="date"
                    id="terminationDate"
                    name="terminationDate"
                  />
                </div>

                <div class="request-form">
                  <label for="salary">Salary:</label>
                  <input type="number" id="salary" name="salary" />
                  <select id="salaryComparison" name="salaryComparison">
                    <option value="equal">Equal to</option>
                    <option value="greater">Greater than</option>
                    <option value="less">Less than</option>
                  </select>
                </div>

                <div class="request-group">
                  <button type="submit">Submit</button>
                </div>
              </form>
            </div>
          </div>

          <h2>Employee Information</h2>
          <table id="employeeTable">
            <thead>
              <tr>
                <th>Employee ID</th>
                <th>Name</th>
                <th>Title</th>
                <th>Start Date</th>
                <th>Termination Date</th>
                <th>Salary</th>
              </tr>
            </thead>
            <tbody>
              <!-- Employee information goes here -->
            </tbody>
          </table>
        </div>

        <div id="reports">
          <div class="sales">
            <h2>Sales Report Generator</h2>

            <div id="reportForm">
              <div class="fieldBox">
                <label>
                  <input type="checkbox" id="fieldAmount" /> Amount
                </label>
                <select id="amountComparison" name="amountComparison">
                  <option value="=">Equal to</option>
                  <option value=">">Greater than</option>
                  <option value="<">Less than</option>
                </select>
                <input type="number" id="amount" name="amount" />
              </div>

              <div class="fieldBox">
                <label>
                  <input type="checkbox" id="fieldLocation" /> Location
                </label>
                <select id="location" name="location">
                  <option disabled selected value="">Select a location</option>
                  <option value="1">4516 Burleson Rd, Austin, TX 78744</option>
                  <option value="2">
                    3740 Greenbriar Dr, Houston, TX 77098
                  </option>
                  <option value="3">515 Centre St, Dallas, TX 75208</option>
                  <option value="4">219 E Mills Ave, El Paso, TX 79901</option>
                  <option value="5">5001 Avenue L, Lubbock, TX 79452</option>
                  <option value="6">3903 Melear Dr, Arlington, TX 76015</option>
                  <option value="7">
                    1140 S Laredo St, San Antonio, TX 78204
                  </option>
                  <option value="8">
                    5200 W University Blvd, Odessa, TX 79764
                  </option>
                  <option value="9">
                    10515 Stonewall Blvd, Corpus Christi, TX 78410
                  </option>
                  <option value="10">423 Los Alamos Dr, Alamo, TX 78516</option>
                </select>
              </div>

              <div class="fieldBox">
                <label> <input type="checkbox" id="fieldDate" /> Date </label>
                <select id="dateComparison" name="dateComparison">
                  <option value="=">On</option>
                  <option value=">">Before</option>
                  <option value="<">After</option>
                </select>
                <input
                  type="text"
                  id="date"
                  name="date"
                  pattern="\d{4}-\d{2}-\d{2}"
                  placeholder="YYYY-MM-DD"
                />
              </div>

              <div class="fieldBox">
                <label>
                  <input type="checkbox" id="fieldEmployeeId" /> Employee ID
                </label>
                <input type="number" id="employeeId" name="employeeId" />
              </div>

              <button onclick="generateReport()">Generate Report</button>
            </div>

            <div id="result">
              <h3>Generated Report:</h3>
              <ul id="reportList"></ul>
            </div>
          </div>
        </div>
        <div id="supportreport"></div>
        <script>
          function signOut() {
              // Perform logout logic here, e.g., clearing session storage, etc.
      
              // Redirect to index.html after logout
              window.location.href = "/index.html";
          }
        </script>
      </main>
    </div>
    <script>
      const links = document.querySelectorAll(".side-nav a");

      links.forEach((link) => {
        link.addEventListener("click", (event) => {
          event.preventDefault(); // Prevent the default link behavior (optional)

          // Remove the "clicked" class from all links
          links.forEach((otherLink) => {
            otherLink.classList.remove("clicked");
          });

          // Add the "clicked" class to the clicked link
          link.classList.add("clicked");
        });
      });

      function loadContent(contentId) {
        // Hide all content divs
        const contentDivs = document.querySelectorAll(".content > div");
        contentDivs.forEach((div) => {
          div.style.display = "none";
        });

        // Show the selected content
        document.getElementById(contentId).style.display = "block";
      }
      // Set the "Home" link to be lit up by default
      const homeLink = document.querySelector(".side-nav a[href='#']");
      homeLink.classList.add("clicked");
      loadContent("dashboard");


      /***************************************** REPORTS PAGE **********************************************************/
      /* will send the POST Request once generate report button is clicked based off of user input SQL query based on user input  */

      const BASE_URL = 'http://localhost:5500';
      //const BASE_URL = 'https://westernexpresspostal.azurewebsites.net'
      if (typeof require !== "undefined") {
        const path = require("path");
        require("dotenv").config({ path: path.resolve(__dirname, "../../.env") });
        }
        
        function generateReport() {
        const amountChecked = document.getElementById("fieldAmount").checked;
        const locationChecked = document.getElementById("fieldLocation").checked;
        const dateChecked = document.getElementById("fieldDate").checked;
        const employeeIdChecked = document.getElementById("fieldEmployeeId").checked;
        
        // Check if none of the checkboxes are checked
        if (!(amountChecked || locationChecked || dateChecked || employeeIdChecked)) {
          // You can display a message to the user or simply return
          console.log("Please select at least one filter to generate a report.");
          return;
        }
        
        const requestData = {
          amount: document.getElementById("amount").value,
          amountComparison: document.getElementById("amountComparison").value,
          location: document.getElementById("location").value,
          date: document.getElementById("date").value,
          dateComparison: document.getElementById("dateComparison").value,
          employeeId: document.getElementById("employeeId").value,
        };
        
        let query = `
        SELECT s.amount, s.sale_date, f.emp_id, f.first_name, f.last_name
        FROM dbo.sales s
        INNER JOIN dbo.employees_new f ON s.emp_id = f.emp_id
        `;
        
        let whereClauses = [];
        
        if (
          document.getElementById("fieldAmount").checked &&
          requestData.amount !== undefined
        ) {
          const sqlOperator =
          requestData.amountComparison === "greater than"
            ? ">"
            : requestData.amountComparison;
          whereClauses.push(`s.amount ${sqlOperator} ${requestData.amount}`);
        }
        
        // modify location
        if (document.getElementById("fieldLocation").checked) {
          query += ` INNER JOIN dbo.post_office_details pd ON s.address_id = pd.address_id`;
          whereClauses.push(`pd.postoffice_id = ${requestData.location}`);
        }
        
        if (document.getElementById("fieldDate").checked) {
          whereClauses.push(
          `s.sale_date ${requestData.dateComparison} '${requestData.date}'`
          );
        }
        
        if (document.getElementById("fieldEmployeeId").checked) {
          whereClauses.push(`f.emp_id = '${requestData.employeeId}'`);
        }
        
        // Combine WHERE clauses if there are any
        if (whereClauses.length > 0) {
          query += ` WHERE ${whereClauses.join(" AND ")}`;
        }
        
        //See SQL Query
        console.log("Generated SQL query:", query);
        /* sebastian added azure website path to fetch url */
        fetch(`${BASE_URL}/generateReport`, {
          method: "POST",
          headers: {
          "Content-Type": "application/json",
          },
          body: JSON.stringify({ query }), // Sending the constructed query to the backend
        })
          .then((response) => {
          if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
          }
          return response.json();
          })
          .then((data) => {
          const reportList = document.getElementById("reportList");
          reportList.innerHTML = "";
        
          // Inside the data.forEach loop where list items are created
          data.forEach((item) => {
            const listItem = document.createElement("li");
        
            // Format the date to display only the date part
            const formattedDate = new Date(item.sale_date)
            .toISOString()
            .split("T")[0];
        
            // Include emp_id in the list item text content
            listItem.textContent = `Amount: ${item.amount}, Date: ${formattedDate}, Employee ID: ${item.emp_id}, Employee Name: ${item.first_name} ${item.last_name}`;
            reportList.appendChild(listItem);
          });
        
          const resultContainer = document.getElementById("result");
          resultContainer.style.display = "block";
          })
          .catch((error) => {
          console.error(error);
          });
        }


///////////customer data///////////////
async function fetchData(){
  try {
    const response = await fetch(`${BASE_URL}/login/customerData`);
    const data = await response.json();
    customerTable(data, "customerData");
  }
  catch(error){
    console.error("Fetch error: ", error);
  }
}
document.addEventListener("DOMContentLoaded", fetchData);

function customerTable(data, elementToBind) {           
    if (!Array.isArray(data) || data.length === 0 || typeof data[0] !== 'object') {
      console.error('Invalid data format or empty');
      return;
    }

    var col = [];
    for (var i = 0; i < data.length; i++) {
      for (var key in data[i]) {
        if (col.indexOf(key) === -1) {
          col.push(key);
        }
      }
    }

    var table = document.createElement("table");
    var tr = table.insertRow(-1);

    for (var i = 0; i < col.length; i++) {
      var th = document.createElement("th");
      th.innerHTML = col[i];
      tr.appendChild(th);
    }

    for (var i = 0; i < data.length; i++) {
    tr = table.insertRow(-1);

    for (var j = 0; j < col.length; j++) {
      var tabCell = tr.insertCell(-1);

      if (col[j] === 'send_date') {
        // Check if the column represents a date
        const dateValue = new Date(data[i][col[j]]);
        tabCell.innerHTML = dateValue.toISOString().split('T')[0]; // Format date as 'YYYY-MM-DD'
      } else {
        tabCell.innerHTML = data[i][col[j]];
      }
    }
  }

    var divContainer = document.getElementById(elementToBind);
    divContainer.innerHTML = "";
    divContainer.appendChild(table);
  }
    </script>
    <!--<script type="text/js" src="/js/admin_home.js"></script>
    <script type="text/js" src="/index/admin/js/adminreport1.js"></script>-->
  </body>
</html>